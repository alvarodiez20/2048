<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="description"
    content="Play 2048 - A sliding puzzle game built with Rust and WebAssembly. Play on mobile with touch gestures!" />
  <meta name="theme-color" content="#0f0f1a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="2048" />
  <title>2048 - Rust + WASM</title>
  <link rel="stylesheet" href="/src/style.css" />
</head>

<body>
  <div id="app">
    <header>
      <h1>2048</h1>
    </header>

    <div class="game-header">
      <div class="score-container">
        <div class="score-label">SCORE</div>
        <div id="score" class="score-value">0</div>
      </div>
      <button id="new-game" class="btn">New Game</button>
    </div>

    <div class="seed-container">
      <label for="seed-input">Seed:</label>
      <input type="number" id="seed-input" value="42" min="0" />
    </div>

    <div class="game-container">
      <canvas id="game-canvas"></canvas>
      <div id="game-over" class="game-over hidden">
        <div class="game-over-content">
          <h2>Game Over!</h2>
          <p>Final Score: <span id="final-score">0</span></p>
          <p>Max Tile: <span id="max-tile">0</span></p>
          <button id="restart" class="btn">Play Again</button>
        </div>
      </div>
    </div>

    <div class="controls">
      <p>
        <span class="desktop-controls">Use <kbd>‚Üë</kbd> <kbd>‚Üì</kbd> <kbd>‚Üê</kbd> <kbd>‚Üí</kbd> or <kbd>W</kbd>
          <kbd>A</kbd> <kbd>S</kbd> <kbd>D</kbd> to move</span>
        <span class="mobile-controls">Swipe to play!</span>
      </p>
    </div>

    <div class="ai-section">
      <h3>ü§ñ AI Player</h3>
      <div class="ai-model-select">
        <label for="model-select">AI Model:</label>
        <select id="model-select">
          <option value="random">Random (baseline)</option>
        </select>
      </div>
      <div id="model-description" class="model-description">
        Select a model to see its description
      </div>
      <div class="ai-controls">
        <button id="watch-ai" class="btn btn-ai" disabled>
          <span class="btn-icon">‚ñ∂</span> Watch AI
        </button>
        <button id="stop-ai" class="btn btn-ai hidden">
          <span class="btn-icon">‚èπ</span> Stop
        </button>
        <button id="ai-hint" class="btn btn-ai" disabled>
          <span class="btn-icon">üí°</span> Hint
        </button>
      </div>
      <div class="ai-speed">
        <label for="ai-speed-slider">Speed:</label>
        <input type="range" id="ai-speed-slider" min="1" max="20" value="5" />
        <span id="speed-value">5</span> moves/sec
      </div>
      <div id="ai-status" class="ai-status">
        <span class="status-dot"></span>
        <span id="ai-status-text">Loading AI model...</span>
      </div>
      <div id="ai-hint-display" class="ai-hint hidden">
        Best move: <span id="hint-action">-</span>
      </div>
    </div>

    <details class="bot-info-section">
      <summary>üìö About the AI Bots</summary>
      <div class="bot-info-content">
        <div class="bot-card">
          <h4>üé≤ Random (Baseline)</h4>
          <p>Picks moves randomly from available legal directions. Used as a baseline to compare other strategies.</p>
          <ul>
            <li><strong>Average Score:</strong> ~1,000-2,000</li>
            <li><strong>Max Tile:</strong> Usually 128-256</li>
            <li><strong>Speed:</strong> Instant</li>
          </ul>
        </div>

        <div class="bot-card highlight">
          <h4>‚ö° Expectimax (Rust) - RECOMMENDED</h4>
          <p><strong>Corner-locked expectimax with bitboards.</strong> Uses pre-computed lookup tables for O(1) move
            operations and searches the game tree to maximize expected value.</p>
          <ul>
            <li><strong>Strategy:</strong> Keeps max tile in top-left corner using snake pattern</li>
            <li><strong>Search:</strong> Expectimax with iterative deepening (depth 2-8)</li>
            <li><strong>Performance:</strong> 10-30x faster than JavaScript version</li>
            <li><strong>Time Budget:</strong> 100ms per move</li>
            <li><strong>Expected Max Tile:</strong> 2048-4096</li>
          </ul>
        </div>

        <div class="bot-card">
          <h4>üß† Expectimax (JavaScript)</h4>
          <p>Same corner-locked strategy as the Rust version, implemented in JavaScript for comparison.</p>
          <ul>
            <li><strong>Strategy:</strong> Identical to Rust (corner-lock + snake)</li>
            <li><strong>Performance:</strong> Slower but same quality moves</li>
            <li><strong>Time Budget:</strong> 400ms per move</li>
            <li><strong>Use Case:</strong> Compare Rust vs JS performance</li>
          </ul>
        </div>

        <div class="bot-card">
          <h4>üéØ DQN Shaped</h4>
          <p>Deep Q-Network trained with reward shaping to encourage good behaviors (empty tiles, high tiles, corner
            positioning).</p>
          <ul>
            <li><strong>Training:</strong> 50,000 episodes via reinforcement learning</li>
            <li><strong>Architecture:</strong> MLP (256‚Üí128 hidden units)</li>
            <li><strong>Framework:</strong> PyTorch on Apple M4 GPU</li>
          </ul>
        </div>

        <div class="bot-card">
          <h4>üñºÔ∏è CNN DQN</h4>
          <p>Convolutional Neural Network that learns spatial patterns on the 4√ó4 board.</p>
          <ul>
            <li><strong>Training:</strong> 25,000 episodes (in progress)</li>
            <li><strong>Architecture:</strong> 2 conv layers (64 channels) + FC (128 units)</li>
            <li><strong>Advantage:</strong> Learns position-aware features automatically</li>
          </ul>
        </div>

        <div class="implementation-notes">
          <h4>üîß Implementation Details</h4>
          <p><strong>Expectimax Rust:</strong> Uses bitboard representation (u64 with 4 bits per tile) and pre-computed
            lookup tables (65,536 entries) for instant move calculations. The gradient heuristic uses powers of 12 to
            strongly prefer snake-pattern tile arrangements.</p>
          <p><strong>Risk-Averse Search:</strong> At chance nodes, blends average and minimum:
            <code>(1-Œ±)√óavg + Œ±√ómin</code> where Œ±=0.25, making moves more conservative.</p>
        </div>
      </div>
    </details>

    <footer>
      <p>Rust + WebAssembly | <a href="https://github.com/alvarodiez20/2048" target="_blank">GitHub</a></p>
    </footer>
  </div>

  <script type="module" src="/src/main.ts"></script>
</body>

</html>